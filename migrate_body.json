{"query":"-- ============================================================\n-- SISTEMA ADM-QUI — Módulo Usuarios + Auditoría\n-- Migración 011: Tabla de usuarios y log de auditoría\n-- Fecha: 2026-02-24\n-- ============================================================\n\n-- =========================\n-- TABLA: usuarios\n-- Máximo ~10 usuarios, todos con mismo acceso\n-- Alta manual por admin\n-- =========================\nCREATE TABLE IF NOT EXISTS usuarios (\n  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,\n  \n  usuario TEXT NOT NULL,              -- Login username (unique)\n  nombre TEXT NOT NULL,               -- Display name\n  password_hash TEXT NOT NULL,        -- Hashed password\n  iniciales TEXT,                     -- Iniciales para avatar (ej: \"LG\")\n  activo BOOLEAN DEFAULT TRUE,       -- Habilitado para login\n  \n  ultimo_login TIMESTAMPTZ,\n  \n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- Unique constraint para login\nALTER TABLE usuarios\n  DROP CONSTRAINT IF EXISTS uq_usuarios_usuario;\nALTER TABLE usuarios\n  ADD CONSTRAINT uq_usuarios_usuario UNIQUE (usuario);\n\n-- Trigger updated_at\nDROP TRIGGER IF EXISTS trg_usuarios_updated ON usuarios;\nCREATE TRIGGER trg_usuarios_updated\n  BEFORE UPDATE ON usuarios\n  FOR EACH ROW EXECUTE FUNCTION update_updated_at();\n\n-- =========================\n-- TABLA: audit_log\n-- Registro de todas las acciones de usuario\n-- =========================\nCREATE TABLE IF NOT EXISTS audit_log (\n  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,\n  \n  user_id UUID REFERENCES usuarios(id),\n  usuario TEXT,                       -- Denormalizado para queries rápidas\n  nombre TEXT,                        -- Denormalizado\n  \n  accion TEXT NOT NULL,               -- Tipo de acción: 'login', 'upload_excel', 'cambio_estado', etc.\n  detalle JSONB DEFAULT '{}',         -- Metadata de la acción (qué cambió, valores, etc.)\n  \n  created_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- Índices para queries de auditoría\nCREATE INDEX IF NOT EXISTS idx_audit_log_user ON audit_log(user_id);\nCREATE INDEX IF NOT EXISTS idx_audit_log_accion ON audit_log(accion);\nCREATE INDEX IF NOT EXISTS idx_audit_log_fecha ON audit_log(created_at DESC);\n\n-- =========================\n-- RLS — Acceso abierto (igual que el resto del sistema)\n-- =========================\nALTER TABLE usuarios ENABLE ROW LEVEL SECURITY;\nALTER TABLE audit_log ENABLE ROW LEVEL SECURITY;\n\nDROP POLICY IF EXISTS allow_all_usuarios ON usuarios;\nCREATE POLICY allow_all_usuarios ON usuarios FOR ALL USING (true) WITH CHECK (true);\n\nDROP POLICY IF EXISTS allow_all_audit_log ON audit_log;\nCREATE POLICY allow_all_audit_log ON audit_log FOR ALL USING (true) WITH CHECK (true);\n\n-- =========================\n-- FUNCIÓN: Verificar password (simple hash comparison via pgcrypto)\n-- =========================\nCREATE EXTENSION IF NOT EXISTS pgcrypto;\n\n-- Función para crear usuario con password hasheada\nCREATE OR REPLACE FUNCTION create_user(\n  p_usuario TEXT,\n  p_nombre TEXT,\n  p_password TEXT,\n  p_iniciales TEXT DEFAULT NULL\n) RETURNS UUID AS $$\nDECLARE\n  new_id UUID;\nBEGIN\n  INSERT INTO usuarios (usuario, nombre, password_hash, iniciales)\n  VALUES (\n    LOWER(TRIM(p_usuario)),\n    TRIM(p_nombre),\n    crypt(p_password, gen_salt('bf')),\n    COALESCE(p_iniciales, UPPER(LEFT(TRIM(p_nombre), 1) || COALESCE(SUBSTRING(TRIM(p_nombre) FROM POSITION(' ' IN TRIM(p_nombre)) + 1 FOR 1), '')))\n  )\n  RETURNING id INTO new_id;\n  RETURN new_id;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER;\n\n-- Función para verificar login\nCREATE OR REPLACE FUNCTION verify_login(\n  p_usuario TEXT,\n  p_password TEXT\n) RETURNS TABLE(id UUID, usuario TEXT, nombre TEXT, iniciales TEXT) AS $$\nBEGIN\n  RETURN QUERY\n  SELECT u.id, u.usuario, u.nombre, u.iniciales\n  FROM usuarios u\n  WHERE u.usuario = LOWER(TRIM(p_usuario))\n    AND u.password_hash = crypt(p_password, u.password_hash)\n    AND u.activo = TRUE;\n    \n  -- Actualizar último login si encontró usuario\n  UPDATE usuarios SET ultimo_login = NOW()\n  WHERE usuarios.usuario = LOWER(TRIM(p_usuario))\n    AND usuarios.password_hash = crypt(p_password, usuarios.password_hash);\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER;\n\n-- =========================\n-- USUARIO ADMIN INICIAL (password: admin123)\n-- Cambiar después del primer login\n-- =========================\nSELECT create_user('admin', 'Administrador', 'admin123', 'AD');\n"}